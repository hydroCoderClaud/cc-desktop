<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é’‰é’‰æ¥å…¥ Agent æ¨¡å¼ - æ¶æ„å›¾</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    padding: 40px;
    min-height: 100vh;
  }
  h1 {
    text-align: center;
    font-size: 24px;
    color: #DA7756;
    margin-bottom: 10px;
  }
  .subtitle {
    text-align: center;
    color: #888;
    font-size: 14px;
    margin-bottom: 40px;
  }
  .diagram {
    max-width: 1100px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 220px 60px 240px 60px 440px;
    grid-template-rows: auto;
    align-items: start;
    gap: 0;
  }

  /* Boxes */
  .box {
    border-radius: 12px;
    padding: 20px;
    position: relative;
  }
  .phone-zone {
    background: #16213e;
    border: 2px solid #0f3460;
    grid-column: 1;
  }
  .cloud-zone {
    background: #1a1a3e;
    border: 2px solid #533483;
    grid-column: 3;
  }
  .desktop-zone {
    background: #162e16;
    border: 2px solid #1e5128;
    grid-column: 5;
  }

  .zone-title {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .phone-zone .zone-title { color: #4fc3f7; }
  .cloud-zone .zone-title { color: #ce93d8; }
  .desktop-zone .zone-title { color: #81c784; }

  .component {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    font-size: 13px;
  }
  .component:last-child { margin-bottom: 0; }
  .component .name {
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
  }
  .component .desc {
    color: #aaa;
    font-size: 12px;
    line-height: 1.4;
  }
  .component.highlight {
    border-color: #DA7756;
    background: rgba(218, 119, 86, 0.1);
  }
  .component.highlight .name { color: #DA7756; }
  .component.new-module {
    border-color: #4fc3f7;
    background: rgba(79, 195, 247, 0.08);
  }
  .component.new-module .name { color: #4fc3f7; }
  .tag {
    display: inline-block;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 4px;
    margin-left: 6px;
    vertical-align: middle;
  }
  .tag-new { background: #4fc3f7; color: #000; }
  .tag-exist { background: #555; color: #ccc; }

  /* Arrows */
  .arrow-col {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding-top: 80px;
  }
  .arrow-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 8px 0;
  }
  .arrow-label {
    font-size: 10px;
    color: #888;
    writing-mode: horizontal-tb;
    text-align: center;
    margin-bottom: 4px;
    line-height: 1.3;
  }
  .arrow-line {
    display: flex;
    align-items: center;
    color: #666;
    font-size: 20px;
    letter-spacing: -2px;
  }
  .arrow-line.right::after { content: 'â†’'; font-size: 16px; }
  .arrow-line.left::after { content: 'â†'; font-size: 16px; }
  .arrow-line.bidir { color: #DA7756; }

  /* Sub-grid inside desktop */
  .desktop-inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .desktop-inner .full-width {
    grid-column: 1 / -1;
  }

  /* Flow section */
  .flow-section {
    max-width: 1100px;
    margin: 50px auto 0;
  }
  .flow-title {
    font-size: 18px;
    color: #DA7756;
    margin-bottom: 20px;
  }
  .flow-steps {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .flow-step {
    flex: 1;
    min-width: 200px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 16px;
  }
  .flow-step .step-num {
    display: inline-block;
    width: 24px;
    height: 24px;
    line-height: 24px;
    text-align: center;
    border-radius: 50%;
    background: #DA7756;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .flow-step .step-title {
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
  }
  .flow-step .step-desc {
    font-size: 12px;
    color: #aaa;
    line-height: 1.5;
  }
  .flow-step.reverse { border-color: #4fc3f7; }
  .flow-step.reverse .step-num { background: #4fc3f7; color: #000; }

  /* Notes */
  .notes {
    max-width: 1100px;
    margin: 40px auto 0;
    background: rgba(218, 119, 86, 0.08);
    border: 1px solid rgba(218, 119, 86, 0.3);
    border-radius: 10px;
    padding: 20px 24px;
  }
  .notes h3 { color: #DA7756; font-size: 15px; margin-bottom: 12px; }
  .notes ul { padding-left: 20px; }
  .notes li { font-size: 13px; color: #bbb; margin-bottom: 6px; line-height: 1.5; }
  .notes li strong { color: #e0e0e0; }
</style>
</head>
<body>

<h1>é’‰é’‰æ¥å…¥ Agent æ¨¡å¼ Â· æ¶æ„å›¾</h1>
<p class="subtitle">æ‰‹æœºé’‰é’‰ â†” é’‰é’‰äº‘ â†” CC Desktopï¼ˆæœ¬åœ°ï¼‰ â†” Claude API</p>

<div class="diagram">

  <!-- æ‰‹æœºç«¯ -->
  <div class="box phone-zone">
    <div class="zone-title">ğŸ“± æ‰‹æœºç«¯</div>
    <div class="component">
      <div class="name">é’‰é’‰ App</div>
      <div class="desc">ç¾¤èŠæˆ–å•èŠä¸­ @æœºå™¨äºº å‘é€æ¶ˆæ¯</div>
    </div>
    <div class="component">
      <div class="name">ç”¨æˆ·æ“ä½œ</div>
      <div class="desc">
        å‘æ–‡å­— â†’ å¯¹è¯<br>
        å‘å›¾ç‰‡ â†’ å¤šæ¨¡æ€<br>
        æ”¶å›å¤ â†’ Markdown
      </div>
    </div>
  </div>

  <!-- ç®­å¤´1 -->
  <div class="arrow-col">
    <div class="arrow-group">
      <div class="arrow-label">@æœºå™¨äºº<br>å‘æ¶ˆæ¯</div>
      <div class="arrow-line right">â”€â”€</div>
    </div>
    <div style="height: 30px;"></div>
    <div class="arrow-group">
      <div class="arrow-label">å›å¤<br>Markdown</div>
      <div class="arrow-line left">â”€â”€</div>
    </div>
  </div>

  <!-- é’‰é’‰äº‘ -->
  <div class="box cloud-zone">
    <div class="zone-title">â˜ï¸ é’‰é’‰äº‘æœåŠ¡å™¨</div>
    <div class="component">
      <div class="name">æ¶ˆæ¯è·¯ç”±</div>
      <div class="desc">è¯†åˆ« @æœºå™¨äºº æ¶ˆæ¯ï¼Œè·¯ç”±åˆ°å¯¹åº”åº”ç”¨</div>
    </div>
    <div class="component">
      <div class="name">Stream é€šé“</div>
      <div class="desc">WebSocket é•¿è¿æ¥<br>ä¸»åŠ¨æ¨é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯<br><strong>æ— éœ€å…¬ç½‘ IP</strong></div>
    </div>
    <div class="component">
      <div class="name">sessionWebhook</div>
      <div class="desc">æ¯æ¡æ¶ˆæ¯é™„å¸¦ä¸´æ—¶å›å¤ URLï¼Œç”¨äºå‘é€å›å¤</div>
    </div>
  </div>

  <!-- ç®­å¤´2 -->
  <div class="arrow-col">
    <div class="arrow-group">
      <div class="arrow-label">WebSocket<br>æ¨é€æ¶ˆæ¯</div>
      <div class="arrow-line bidir right">â”€â”€</div>
    </div>
    <div style="height: 30px;"></div>
    <div class="arrow-group">
      <div class="arrow-label">HTTP POST<br>å›å¤æ¶ˆæ¯</div>
      <div class="arrow-line bidir left">â”€â”€</div>
    </div>
  </div>

  <!-- CC Desktop -->
  <div class="box desktop-zone">
    <div class="zone-title">ğŸ–¥ï¸ CC Desktopï¼ˆæœ¬åœ°è¿è¡Œï¼‰</div>
    <div class="desktop-inner">

      <div class="component new-module full-width">
        <div class="name">DingTalk Bridge <span class="tag tag-new">æ–°å¢</span></div>
        <div class="desc">
          dingtalk-stream-sdk-nodejs å°è£…<br>
          â‘  å¯åŠ¨æ—¶å»ºç«‹ WebSocket é•¿è¿æ¥<br>
          â‘¡ æ¥æ”¶é’‰é’‰æ¶ˆæ¯ â†’ è½¬å‘ç»™ AgentSessionManager<br>
          â‘¢ æ”¶åˆ° Agent å›å¤ â†’ é€šè¿‡ sessionWebhook å›å¤é’‰é’‰
        </div>
      </div>

      <div class="component new-module">
        <div class="name">ä¼šè¯æ˜ å°„ <span class="tag tag-new">æ–°å¢</span></div>
        <div class="desc">
          é’‰é’‰ç”¨æˆ· ID<br>â†” Agent Session ID<br>
          ç»´æŠ¤ 1:1 å¯¹åº”å…³ç³»
        </div>
      </div>

      <div class="component new-module">
        <div class="name">æ¶ˆæ¯é€‚é… <span class="tag tag-new">æ–°å¢</span></div>
        <div class="desc">
          é’‰é’‰æ–‡æœ¬ â†’ Agent æ¶ˆæ¯<br>
          Agent æµå¼è¾“å‡º â†’ æ”’å®Œæ•´å›å¤<br>
          â†’ è½¬ Markdown å‘å›
        </div>
      </div>

      <div class="component highlight full-width">
        <div class="name">AgentSessionManager <span class="tag tag-exist">å·²æœ‰</span></div>
        <div class="desc">
          å¤ç”¨ç°æœ‰ Agent ä¼šè¯ç®¡ç†<br>
          sendMessage() / streaming å“åº” / ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
        </div>
      </div>

      <div class="component full-width">
        <div class="name">Claude Agent SDK â†’ Claude API <span class="tag tag-exist">å·²æœ‰</span></div>
        <div class="desc">
          SDK query() â†’ spawn CLI â†’ Anthropic API<br>
          æµå¼è¿”å› AI å“åº”
        </div>
      </div>

    </div>
  </div>
</div>

<!-- æ¶ˆæ¯æµ -->
<div class="flow-section">
  <div class="flow-title">ğŸ“¨ æ¶ˆæ¯æµï¼šç”¨æˆ·æé—®</div>
  <div class="flow-steps">
    <div class="flow-step">
      <div class="step-num">1</div>
      <div class="step-title">ç”¨æˆ· @æœºå™¨äºº</div>
      <div class="step-desc">åœ¨é’‰é’‰ç¾¤æˆ–å•èŠä¸­å‘é€ "åˆ†æä¸€ä¸‹è¿™æ®µä»£ç çš„æ€§èƒ½é—®é¢˜"</div>
    </div>
    <div class="flow-step">
      <div class="step-num">2</div>
      <div class="step-title">é’‰é’‰äº‘æ¨é€</div>
      <div class="step-desc">é€šè¿‡ WebSocket å°†æ¶ˆæ¯æ¨é€åˆ° CC Desktop çš„ DingTalk Bridge</div>
    </div>
    <div class="flow-step">
      <div class="step-num">3</div>
      <div class="step-title">ä¼šè¯æŸ¥æ‰¾/åˆ›å»º</div>
      <div class="step-desc">æ ¹æ®é’‰é’‰ç”¨æˆ· ID æŸ¥æ‰¾å¯¹åº” Agent Sessionï¼Œä¸å­˜åœ¨åˆ™æ–°å»º</div>
    </div>
    <div class="flow-step">
      <div class="step-num">4</div>
      <div class="step-title">Agent å¤„ç†</div>
      <div class="step-desc">AgentSessionManager.sendMessage() â†’ Claude SDK â†’ æµå¼å“åº”</div>
    </div>
  </div>
</div>

<div class="flow-section">
  <div class="flow-title">ğŸ’¬ æ¶ˆæ¯æµï¼šAI å›å¤</div>
  <div class="flow-steps">
    <div class="flow-step reverse">
      <div class="step-num">5</div>
      <div class="step-title">æ”’å®Œæ•´å›å¤</div>
      <div class="step-desc">ç›‘å¬æµå¼è¾“å‡ºï¼Œç­‰ Agent å›å¤å®Œæ¯•åæ‹¼æˆå®Œæ•´æ–‡æœ¬</div>
    </div>
    <div class="flow-step reverse">
      <div class="step-num">6</div>
      <div class="step-title">æ ¼å¼è½¬æ¢</div>
      <div class="step-desc">Agent è¾“å‡º â†’ é’‰é’‰ Markdown æ ¼å¼ï¼ˆä»£ç å—ã€åˆ—è¡¨ç­‰ï¼‰</div>
    </div>
    <div class="flow-step reverse">
      <div class="step-num">7</div>
      <div class="step-title">å›å¤é’‰é’‰</div>
      <div class="step-desc">HTTP POST åˆ° sessionWebhookï¼Œæ¶ˆæ¯å‡ºç°åœ¨é’‰é’‰å¯¹è¯ä¸­</div>
    </div>
  </div>
</div>

<!-- å…³é”®è¯´æ˜ -->
<div class="notes">
  <h3>ğŸ’¡ å…³é”®è®¾è®¡ç‚¹</h3>
  <ul>
    <li><strong>é›¶å…¬ç½‘ä¾èµ–</strong>ï¼šStream æ¨¡å¼ç”±æœ¬åœ°ä¸»åŠ¨å»ºç«‹ WebSocket è¿æ¥åˆ°é’‰é’‰äº‘ï¼Œä¸éœ€è¦å…¬ç½‘ IPã€åŸŸåã€å†…ç½‘ç©¿é€</li>
    <li><strong>å¤ç”¨ç°æœ‰æ¶æ„</strong>ï¼šæ ¸å¿ƒå¯¹è¯é€»è¾‘å®Œå…¨å¤ç”¨ AgentSessionManager + Claude SDKï¼ŒDingTalk Bridge åªæ˜¯æ–°çš„ "å…¥å£"</li>
    <li><strong>æ–°å¢æ¨¡å—çº¦ 200-300 è¡Œ</strong>ï¼šDingTalk Bridge + ä¼šè¯æ˜ å°„ + æ¶ˆæ¯é€‚é…ï¼Œç¬¦åˆé¡¹ç›®å°æ¨¡å—åŸåˆ™</li>
    <li><strong>é…ç½®é¡¹</strong>ï¼šåœ¨ CC Desktop è®¾ç½®ä¸­æ·»åŠ é’‰é’‰ AppKey / AppSecret / å¼€å…³ï¼Œç”¨æˆ·å¯éšæ—¶å¯åœ</li>
    <li><strong>å‰ææ¡ä»¶</strong>ï¼šéœ€è¦åœ¨é’‰é’‰å¼€å‘è€…åå°åˆ›å»ºä¼ä¸šå†…éƒ¨åº”ç”¨ï¼ˆå…è´¹ï¼‰ï¼Œè·å– AppKey + AppSecret</li>
    <li><strong>å±€é™</strong>ï¼šCC Desktop å¿…é¡»ä¿æŒè¿è¡Œï¼›æµå¼è¾“å‡ºæ— æ³•å®æ—¶æ¨é€ï¼ˆé’‰é’‰ä¸æ”¯æŒï¼‰ï¼Œåªèƒ½æ”’å®Œåä¸€æ¬¡å‘é€</li>
  </ul>
</div>

</body>
</html>
