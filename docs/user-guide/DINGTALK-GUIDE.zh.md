# 钉钉机器人桥接使用指南

通过钉钉机器人桥接功能，你可以在钉钉中直接与 CC Desktop 的 Agent 对话，实现远程访问本地 AI 助手。

## 前提条件

- CC Desktop 已安装并正常运行
- Claude Code CLI 已安装且 API 配置正常
- 拥有钉钉组织的管理员权限（用于创建机器人应用）

## 重要限制

> **一个机器人只能绑定一个桌面端。** 同一组织内，同一个机器人的 AppKey/AppSecret 只能在一台 CC Desktop 上配置使用。多台桌面端同时连接同一个机器人会导致消息丢失或重复回复。如需多人使用，请为每人创建独立的机器人应用。

## 第一步：创建钉钉机器人应用

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 进入「应用开发」→「企业内部开发」→「创建应用」
3. 填写应用名称（如 "CC Desktop AI"）和描述
4. 创建完成后，在应用详情页获取 **AppKey** 和 **AppSecret**

## 第二步：配置机器人能力

1. 在应用详情页，进入「添加应用能力」→ 添加「机器人」
2. 配置机器人信息：
   - 机器人名称：自定义（如 "AI 助手"）
   - 消息接收模式：选择 **Stream 模式**（非 HTTP 模式）
3. 在「权限管理」中确保已开通以下权限：
   - **上传媒体文件**（用于图片转发）
   - **机器人发消息**（用于回复消息）
4. 发布应用（未发布的应用无法使用）

## 第三步：在 CC Desktop 中配置

1. 打开 CC Desktop
2. 点击左下角齿轮图标，选择「钉钉设置」
3. 填写配置：
   - **启用桥接**：打开开关
   - **AppKey**：填入第一步获取的 AppKey
   - **AppSecret**：填入第一步获取的 AppSecret
   - **默认工作目录**：Agent 执行命令的工作目录（可选，强烈建议设置为你的特定目录，方便查看 Agent 生成的文件和成果）
4. 点击「保存」，然后点击「连接」
5. 状态显示「已连接」即配置成功

## 使用方式

### 基本对话

在钉钉中找到机器人，直接发送文本消息即可。机器人会将消息转发给 Agent，并将回复发回钉钉。

### 发送图片给 Agent

在钉钉对话中直接发送图片，Agent 会自动识别图片内容并回复。

### Agent 图片转发

当 Agent 在处理过程中使用工具读取了本地图片文件（如通过 Read 工具），该图片会自动转发到钉钉。

**提示**：如果希望 Agent 生成图片后自动发送到钉钉，可以在提示词中加上"生成后请读取该图片"，确保 Agent 使用 Read 工具读取图片文件。

## 常见问题

### 连接失败

- 确认 AppKey 和 AppSecret 是否正确
- 确认应用已发布
- 确认机器人消息接收模式为 Stream 模式
- 检查网络是否能访问钉钉服务器

### 消息无回复

- 确认 CC Desktop 状态栏显示「已连接」
- 确认 Claude Code CLI 的 API 配置正常
- 查看 CC Desktop 开发者工具（F12）中的控制台日志

### 图片无法转发到钉钉

- 确认已开通「上传媒体文件」权限
- 确认图片文件大小不超过 20MB
- 确认 Agent 确实使用了 Read 工具读取图片（仅文本中提到路径不会触发转发）

### 收到重复回复

- 检查是否有多台桌面端配置了同一个机器人，请确保一个机器人只绑定一个桌面端
