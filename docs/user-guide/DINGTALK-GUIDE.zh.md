# 钉钉机器人桥接使用指南

通过钉钉机器人桥接功能，你可以在钉钉中直接与 CC Desktop 的 Agent 对话，实现远程访问本地 AI 助手。

## 前提条件

- CC Desktop 已安装并正常运行
- Claude Code CLI 已安装且 API 配置正常
- 拥有钉钉组织的管理员权限（用于创建机器人应用）

## 重要限制

> **一个机器人只能绑定一个桌面端。** 同一组织内，同一个机器人的 AppKey/AppSecret 只能在一台 CC Desktop 上配置使用。多台桌面端同时连接同一个机器人会导致消息丢失或重复回复。如需多人使用，请为每人创建独立的机器人应用。

## 第一步：创建钉钉机器人应用

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 进入「应用开发」→「企业内部开发」→「创建应用」
3. 填写应用名称（如 "CC Desktop AI"）和描述
4. 创建完成后，在应用详情页获取 **AppKey** 和 **AppSecret**

## 第二步：配置机器人能力

1. 在应用详情页，进入「添加应用能力」→ 添加「机器人」
2. 配置机器人信息：
   - 机器人名称：自定义（如 "AI 助手"）
   - 消息接收模式：选择 **Stream 模式**（非 HTTP 模式）
3. 在「权限管理」中确保已开通以下权限：
   - **上传媒体文件**（用于图片转发）
   - **机器人发消息**（用于回复消息）
4. 发布应用（未发布的应用无法使用）

## 第三步：在 CC Desktop 中配置

1. 打开 CC Desktop
2. 点击左下角齿轮图标，选择「钉钉设置」
3. 填写配置：
   - **启用桥接**：打开开关
   - **AppKey**：填入第一步获取的 AppKey
   - **AppSecret**：填入第一步获取的 AppSecret
   - **默认工作目录**：Agent 执行命令的工作目录（可选，强烈建议设置为你的特定目录，方便查看 Agent 生成的文件和成果）
4. 点击「保存」，然后点击「连接」
5. 状态显示「已连接」即配置成功

## 使用方式

### 基本对话

在钉钉中找到机器人，直接发送文本消息即可。机器人会将消息转发给 Agent，并将回复发回钉钉。

### 发送图片给 Agent

在钉钉对话中直接发送图片，Agent 会自动识别图片内容并回复。

### Agent 图片转发

当 Agent 在处理过程中使用工具读取了本地图片文件（如通过 Read 工具），该图片会自动转发到钉钉。

**提示**：如果希望 Agent 生成图片后自动发送到钉钉，可以在提示词中加上"生成后请读取该图片"，确保 Agent 使用 Read 工具读取图片文件。

---

## 会话管理

### 会话隔离

不同群或单聊发起的对话相互隔离，各自维护独立的 Agent 会话和上下文。同一个群里的消息共用一个会话。

### 历史会话选择

当 CC 桌面关闭了某个钉钉会话后，下次在钉钉发消息，机器人会列出历史会话供选择：

```
您有以下历史会话，请回复数字选择：

1. [2小时前] 代码审查任务
2. [昨天] Python 脚本生成

回复 0 开始全新会话
```

- 回复 **0**：创建全新会话，从头开始
- 回复 **1~N**：恢复对应历史会话（包含历史上下文，Agent 可继续之前的对话）

**等待选择期间继续发消息**：机器人会重复显示选择菜单，并以你**最后一条**消息作为选定会话后的第一个问题（前几条消息会被替换）。

### 正在处理时发消息

如果 CC 桌面正在处理某个请求（Agent 生成回复中），此时钉钉发来的消息会收到提示：

```
⏳ 正在处理中，请稍候再试
```

等 Agent 回复完成后再发送即可。

---

## CC 桌面介入

### 什么是介入

钉钉发起的会话同时在 CC 桌面可见。当 CC 桌面用户（而非钉钉用户）在该会话窗口中直接输入问题并获得 Agent 回复时，这次交互称为"桌面端介入"。

### 介入内容自动同步

桌面端介入的完整 Q&A 会自动发送到钉钉，格式如下：

```
💻 桌面端介入：
> 帮我检查一下最新的日志文件

日志中发现 3 处异常，分别位于...（Agent 完整回复）
```

如果 Agent 在介入过程中读取了图片文件，图片同样会转发到钉钉。

### 介入的适用场景

- 钉钉用户提了一个需要操作本地文件的复杂问题，CC 桌面用户直接在桌面端完成并让钉钉用户看到结果
- 钉钉用户不在线时进行的操作，等对方回来时可以在钉钉查看历史记录
- 多人协作：一人发起任务，另一人在桌面端处理，钉钉群自动记录过程

## 常见问题

### 连接失败

- 确认 AppKey 和 AppSecret 是否正确
- 确认应用已发布
- 确认机器人消息接收模式为 Stream 模式
- 检查网络是否能访问钉钉服务器

### 消息无回复

- 确认 CC Desktop 状态栏显示「已连接」
- 确认 Claude Code CLI 的 API 配置正常
- 查看 CC Desktop 开发者工具（F12）中的控制台日志

### 图片无法转发到钉钉

- 确认已开通「上传媒体文件」权限
- 确认图片文件大小不超过 20MB
- 确认 Agent 确实使用了 Read 工具读取图片（仅文本中提到路径不会触发转发）

### 收到重复回复

- 检查是否有多台桌面端配置了同一个机器人，请确保一个机器人只绑定一个桌面端
