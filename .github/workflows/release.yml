name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v1.6.39 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build macOS apps
        run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_DIR="cc-desktop-v${VERSION}-macos"

          mkdir -p "$RELEASE_DIR"
          cp "dist/CC Desktop-${VERSION}-darwin-arm64.dmg" "$RELEASE_DIR/"
          cp "dist/CC Desktop-${VERSION}-darwin-x64.dmg" "$RELEASE_DIR/"
          cp scripts/install.sh "$RELEASE_DIR/"

          # åˆ›å»º README
          cat > "$RELEASE_DIR/README.md" << 'EOF'
          # CC Desktop v$VERSION

          ## Quick Install (Recommended)

          ```bash
          bash install.sh
          ```

          This will:
          1. Detect your system architecture (ARM64 or x64)
          2. Check if Claude Code CLI is installed (install if not)
          3. Install CC Desktop to /Applications

          ## Manual Install

          - **Apple Silicon (M1/M2/M3)**: Double-click `CC Desktop-${VERSION}-darwin-arm64.dmg`
          - **Intel**: Double-click `CC Desktop-${VERSION}-darwin-x64.dmg`

          Then drag to Applications folder.
          EOF

          # æ‰“åŒ…
          tar czf "cc-desktop-v${VERSION}-macos.tar.gz" "$RELEASE_DIR"

          # å•ç‹¬çš„ DMG æ–‡ä»¶ä¹Ÿä½œä¸º asset
          cp "dist/CC Desktop-${VERSION}-darwin-arm64.dmg" .
          cp "dist/CC Desktop-${VERSION}-darwin-x64.dmg" .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            cc-desktop-v*-macos.tar.gz
            CC Desktop-*-darwin-arm64.dmg
            CC Desktop-*-darwin-x64.dmg
          body: |
            ## ðŸš€ CC Desktop ${{ github.ref_name }}

            ### ä¸€é”®å®‰è£…ï¼ˆæŽ¨èï¼‰

            ```bash
            # ä¸‹è½½å¹¶è§£åŽ‹
            curl -L -O https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/cc-desktop-${{ github.ref_name }}-macos.tar.gz
            tar xzf cc-desktop-${{ github.ref_name }}-macos.tar.gz
            cd cc-desktop-${{ github.ref_name }}-macos

            # è¿è¡Œå®‰è£…è„šæœ¬ï¼ˆè‡ªåŠ¨æ£€æµ‹æž¶æž„å’Œå®‰è£… Claude CLIï¼‰
            bash install.sh
            ```

            ### æ‰‹åŠ¨å®‰è£…

            #### Apple Silicon (M1/M2/M3)
            ä¸‹è½½ `CC Desktop-*-darwin-arm64.dmg`

            #### Intel
            ä¸‹è½½ `CC Desktop-*-darwin-x64.dmg`

            ### åŠŸèƒ½ç‰¹æ€§

            - åŒæ¨¡å¼æž¶æž„ï¼šTerminal æ¨¡å¼ + Agent æ¨¡å¼
            - å¤šä¼šè¯ç®¡ç†
            - æ”¯æŒæ¢å¤åŽ†å²ä¼šè¯
            - å†…ç½® Agent å¯¹è¯ç•Œé¢

            ### ç³»ç»Ÿè¦æ±‚

            - macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
            - Claude Code CLIï¼ˆå®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥å’Œå®‰è£…ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
